name: Build Java Images

on:
  workflow_dispatch:


jobs:
  just-test:
    runs-on: ubuntu-latest    
    steps:
      - name: Build Placeholder
        run: |
          echo "-------------------------------------------------------"
          echo "ðŸš€ Specter Stack: Java Build Pipeline Triggered!"
          echo "Status: Monitoring versions.json for changes..."
          echo "Action: Preparing to build JDK 8, 11, 17, 21, 25"
          echo "Target Architecture: linux/amd64, linux/arm64"
          echo "Bake process will be executed here in the next step."
          echo "-------------------------------------------------------"
  build:
      runs-on: ubuntu-latest
      permissions:
        contents: read
        packages: write
        id-token: write 
      strategy:
        fail-fast: false
        matrix:
          java_version: [17]

      steps:
        - name: Checkout Code
          uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            registry: docker.io
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_PASSWORD }}
        - name: Extract Metadata from JSON
          id: meta
          run: |
            echo "wolfi_base=$(jq -r '.wolfi.base.digest' versions.json)" >> $GITHUB_OUTPUT
            echo "wolfi_static=$(jq -r '.wolfi.static.digest' versions.json)" >> $GITHUB_OUTPUT
            echo "jdk_amd_url=$(jq -r ".java${{ matrix.java_version }}.jdk.amd64.url" versions.json)" >> $GITHUB_OUTPUT
            echo "jdk_amd_sha=$(jq -r ".java${{ matrix.java_version }}.jdk.amd64.sha" versions.json)" >> $GITHUB_OUTPUT
            echo "jdk_arm_url=$(jq -r ".java${{ matrix.java_version }}.jdk.arm64.url" versions.json)" >> $GITHUB_OUTPUT
            echo "jdk_arm_sha=$(jq -r ".java${{ matrix.java_version }}.jdk.arm64.sha" versions.json)" >> $GITHUB_OUTPUT
            echo "jre_amd_url=$(jq -r ".java${{ matrix.java_version }}.jre.amd64.url" versions.json)" >> $GITHUB_OUTPUT
            echo "jre_amd_sha=$(jq -r ".java${{ matrix.java_version }}.jre.amd64.sha" versions.json)" >> $GITHUB_OUTPUT
            echo "jre_arm_url=$(jq -r ".java${{ matrix.java_version }}.jre.arm64.url" versions.json)" >> $GITHUB_OUTPUT
            echo "jre_arm_sha=$(jq -r ".java${{ matrix.java_version }}.jre.arm64.sha" versions.json)" >> $GITHUB_OUTPUT
            echo "full_ver=$(jq -r ".java${{ matrix.java_version }}.jdk.amd64.openjdk_version" versions.json)" >> $GITHUB_OUTPUT
            echo "sec_lvl=$(jq -r ".java${{ matrix.java_version }}.jdk.amd64.security_level" versions.json)" >> $GITHUB_OUTPUT
            echo "semver=$(jq -r ".java${{ matrix.java_version }}.jdk.amd64.semver" versions.json)" >> $GITHUB_OUTPUT
            echo "scm_ref=$(jq -r ".java${{ matrix.java_version }}.jdk.amd64.scm_ref" versions.json)" >> $GITHUB_OUTPUT
            echo "updated_at=$(jq -r ".java${{ matrix.java_version }}.jdk.amd64.updated_at" versions.json)" >> $GITHUB_OUTPUT

        - name: Docker Bake (Build and Push)
          uses: docker/bake-action@v5
          with:
            files: |
              docker-bake.hcl
              versions/${{ matrix.java_version }}/build.hcl
                  targets: java${{ matrix.java_version }}
                  push: true
                  set: |
                    JAVA${{ matrix.java_version }}_JRE_AMD64_URL=${{ steps.meta.outputs.jre_amd_url }}
                    JAVA${{ matrix.java_version }}_JRE_AMD64_SHA=${{ steps.meta.outputs.jre_amd_sha }}
                    JAVA${{ matrix.java_version }}_JRE_ARM64_URL=${{ steps.meta.outputs.jre_arm_url }}
                    JAVA${{ matrix.java_version }}_JRE_ARM64_SHA=${{ steps.meta.outputs.jre_arm_sha }}
                    JAVA${{ matrix.java_version }}_JDK_AMD64_URL=${{ steps.meta.outputs.jdk_amd_url }}
                    JAVA${{ matrix.java_version }}_JDK_AMD64_SHA=${{ steps.meta.outputs.jdk_amd_sha }}
                    JAVA${{ matrix.java_version }}_JDK_ARM64_URL=${{ steps.meta.outputs.jdk_arm_url }}
                    JAVA${{ matrix.java_version }}_JDK_ARM64_SHA=${{ steps.meta.outputs.jdk_arm_sha }}
                    JAVA${{ matrix.java_version }}_FULL_VER=${{ steps.meta.outputs.full_ver }}
                    JAVA${{ matrix.java_version }}_SEC_LEVEL=${{ steps.meta.outputs.sec_lvl }}
                    JAVA${{ matrix.java_version }}_SEMVER=${{ steps.meta.outputs.semver }}
                    JAVA${{ matrix.java_version }}_SCM_REF=${{ steps.meta.outputs.scm_ref }}
                    JAVA${{ matrix.java_version }}_UPSTREAM_UPDATE=${{ steps.meta.outputs.updated_at }}
                    WOLFI_BASE_DIGEST=${{ steps.meta.outputs.wolfi_base }}
                    WOLFI_STATIC_DIGEST=${{ steps.meta.outputs.wolfi_static }}